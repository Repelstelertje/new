---
import Base from "../../layouts/Base.astro";
import { loadAllProfiles } from "../../lib/load-profiles";
import { slugifyName } from "../../lib/slug";

export async function getStaticPaths() {
  const rows = loadAllProfiles();
  const paths = rows
    .map((r) => {
      const idString = String(r?.profile_id ?? "").trim();
      if (!idString) return undefined;

      const nameSlug = r?.profile_name ? slugifyName(r.profile_name) : "";
      const idSlug = slugifyName(idString);
      const safeNameSlug = nameSlug && nameSlug.length <= 80 ? nameSlug : "";
      const safeIdSlug = idSlug && idSlug.length <= 80 ? idSlug : "";
      const slugSource = safeNameSlug || safeIdSlug || idSlug || idString;
      const slug = slugSource.length > 80 ? slugSource.slice(0, 80) : slugSource;
      if (!slug) return undefined;

      return {
        params: { slug },
        props: {
          ssrProfile: {
            id: idString,
            name: r.profile_name ?? "",
            province: r.province ?? "",
            city: r.city ?? "",
            age: r.age ? Number.parseInt(r.age, 10) : undefined,
            height: r.length ?? "",
            description: r.aboutme ?? "",
            img: { src: r.profile_image ?? "/img/fallback.svg", alt: r.profile_name ?? "Profielafbeelding" },
          },
        },
      };
    })
    .filter(Boolean);
  return paths;
}

const { ssrProfile } = Astro.props as {
  ssrProfile?: {
    id: string;
    name: string;
    province?: string;
    city?: string;
    age?: number;
    height?: string;
    description?: string;
    img?: { src: string; alt: string };
  };
};

// ID uit query; bij mismatch NIET meer 404’en — we tonen SSG en laten JS de deeplink bijwerken
const q = new URL(Astro.url).searchParams;
const idParam = q.get("id") ?? (ssrProfile?.id ?? "");

// SEO & canonical
const title = ssrProfile?.name ? `Date met ${ssrProfile.name}${ssrProfile.province ? ` in ${ssrProfile.province}` : ""}` : "Profiel";
const description = ssrProfile?.description ?? `Leer dit profiel kennen en stuur gratis een bericht.`;
const canonicalPath = `${Astro.url.pathname}${idParam ? `?id=${encodeURIComponent(String(idParam))}` : ""}`;

// Afbeelding + fallback
const imgSrc = ssrProfile?.img?.src ?? "/img/fallback.svg";
const imgAlt = ssrProfile?.img?.alt ?? ssrProfile?.name ?? "Profielafbeelding";

const hasSSG = Boolean(ssrProfile);

// JSON-LD minimaal
const personLd = ssrProfile?.name ? { "@type": "Person", name: ssrProfile.name, description: ssrProfile.description ?? undefined } : undefined;
---
<Base title={title} description={description} path={canonicalPath} staging={import.meta.env.STAGING} jsonLd={personLd ? [personLd] : []}>
  {hasSSG ? (
    <article class="mx-auto grid max-w-5xl grid-cols-1 gap-8 md:grid-cols-[360px,1fr]">
      <div class="overflow-hidden rounded-2xl border border-neutral-200 bg-white">
        <img
          id="profile-img"
          src={imgSrc}
          alt={imgAlt}
          loading="eager"
          decoding="async"
          class="block h-auto w-full object-cover"
          data-fallback-src="/img/fallback.svg"
        />
      </div>

      <div class="space-y-4">
        <header>
          <h1 class="text-3xl font-bold text-neutral-900">{ssrProfile!.name}</h1>
          <p class="text-neutral-700">
            {(ssrProfile!.age ? `${ssrProfile!.age} jaar · ` : "")}{ssrProfile!.city || ssrProfile!.province}
          </p>
        </header>

        {ssrProfile!.description && (
          <p class="text-neutral-800 leading-relaxed">{ssrProfile!.description}</p>
        )}

        <section class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Provincie</p>
            <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.province}</p>
          </div>

          {ssrProfile!.city && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Stad</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.city}</p>
            </div>
          )}

          {ssrProfile!.age && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Leeftijd</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.age}</p>
            </div>
          )}

          {ssrProfile!.height && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Lengte</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.height}</p>
            </div>
          )}
        </section>

        <div class="pt-2">
          <a
            id="profile-cta"
            href="#"
            rel="nofollow sponsored noopener"
            target="_blank"
            class="inline-flex items-center justify-center rounded-full bg-sky-600 px-6 py-3 text-base font-semibold text-white transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
            aria-label="Stuur gratis bericht"
          >
            Stuur gratis bericht
          </a>
        </div>
      </div>
    </article>
  ) : (
    // Geen SSG-match → render container; client-fallback bouwt volledige view
    <>
      <div id="profile-view"></div>
    </>
  )}
  <script type="module" src="/js/profile-fallback.js"></script>
</Base>
