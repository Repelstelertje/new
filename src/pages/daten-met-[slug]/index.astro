---
import Base from "../../layouts/Base.astro";
import { slugifyName } from "../../lib/slug";
import { loadAllProfiles } from "../../lib/load-profiles";

type CardProfile = {
  id: string;
  name: string;
  age?: number;
  province?: string;
  city?: string;
  length?: string;
  description?: string;
  img?: { src: string; alt: string; srcset?: string; sizes?: string };
  deeplink?: string;
};

export async function getStaticPaths() {
  const csv = loadAllProfiles();
  const paths: { params: { slug: string }; props: { profile: CardProfile } }[] = [];
  for (const r of csv) {
    const slug = slugifyName(r.profile_name);
    const p: CardProfile = {
      id: String(r.profile_id),
      name: r.profile_name,
      age: r.age ? Number(r.age) : undefined,
      province: r.province,
      city: r.city,
      length: r.length,
      description: r.aboutme,
      img: r.profile_image ? { src: r.profile_image, alt: r.profile_name } : undefined,
    };
    paths.push({ params: { slug }, props: { profile: p } });
  }
  return paths;
}

const { profile } = Astro.props as { profile: CardProfile };

const q = new URL(Astro.url).searchParams;
const idParam = q.get("id") ?? profile.id;

const title = `Date met ${profile.name}${profile.province ? " in " + profile.province : ""}`;
const description = profile.description ?? `Leer ${profile.name} kennen en stuur gratis een bericht.`;
const canonicalPath = `${Astro.url.pathname}?id=${encodeURIComponent(String(idParam))}`;

const imgSrc = profile.img?.src ?? "/img/fallback.svg";
const imgAlt = profile.img?.alt ?? profile.name;

const analyticsProps = JSON.stringify({
  profile_id: String(profile.id),
  province: profile.province,
  chat_url: profile.deeplink,
});

const personLd = { "@type": "Person", name: profile.name, description: profile.description ?? undefined };
---
<Base title={title} description={description} path={canonicalPath} staging={import.meta.env.STAGING} jsonLd={[personLd]}>
  <article class="mx-auto grid max-w-5xl grid-cols-1 gap-8 md:grid-cols-[360px,1fr]">
    <div class="overflow-hidden rounded-2xl border border-neutral-200 bg-white">
      <img
        src={imgSrc}
        alt={imgAlt}
        loading="eager"
        decoding="async"
        class="block h-auto w-full object-cover"
        data-fallback-src={"/img/fallback.svg"}
      />
    </div>

    <div class="space-y-4">
      <header>
        <h1 class="text-3xl font-bold text-neutral-900">{profile.name}</h1>
        <p class="text-neutral-700">
          {profile.age ? `${profile.age} jaar` : ""}{profile.age && (profile.city || profile.province) ? " Â· " : ""}{profile.city ?? profile.province}
        </p>
      </header>

      {profile.description && (
        <p class="text-neutral-800 leading-relaxed">{profile.description}</p>
      )}

      <section class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-xl border border-neutral-200 bg-white p-4">
          <p class="text-xs uppercase tracking-wide text-neutral-500">Provincie</p>
          <p class="mt-1 font-medium text-neutral-900">{profile.province}</p>
        </div>

        {profile.city && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Stad</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.city}</p>
          </div>
        )}

        {profile.age && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Leeftijd</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.age}</p>
          </div>
        )}

        {profile.length && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Lengte</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.length}</p>
          </div>
        )}
      </section>

      {profile.deeplink && (
        <div class="pt-2">
          <a
            href={profile.deeplink}
            rel="nofollow sponsored noopener"
            target="_blank"
            class="inline-flex items-center justify-center rounded-full bg-sky-600 px-6 py-3 text-base font-semibold text-white transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
            aria-label="Stuur gratis bericht"
            data-analytics="outbound_click"
            data-props={analyticsProps}
          >
            Stuur gratis bericht
          </a>
        </div>
      )}
    </div>
  </article>
</Base>
