---
import Base from "../../layouts/Base.astro";
import { slugifyName } from "../../lib/slug";
import fs from "node:fs";
import path from "node:path";

// --- CSV helpers (in-scope voor getStaticPaths) ---
type CsvRow = {
  profile_id: string;
  profile_name: string;
  province?: string;
  city?: string;
  age?: string;
  length?: string;
  aboutme?: string;
  profile_image?: string;
};

function readCsv(filePath: string): CsvRow[] {
  // Gebruik process.cwd() i.p.v. Astro.root.pathname om paden stabiel te resolven in build.
  const abs = path.resolve(process.cwd(), filePath);
  if (!fs.existsSync(abs)) return [];
  const text = fs.readFileSync(abs, "utf8");
  const lines = text.split(/\r?\n/).filter(Boolean);
  if (lines.length === 0) return [];
  const headerLine = lines[0];
  const headers = headerLine.split(",").map((h) => h.trim());
  const rows = lines.slice(1);
  return rows.map((ln) => {
    // Eenvoudige CSV parser (veldnamen zonder quotes/comma’s in velden)
    const cols = ln.split(",").map((c) => c.trim());
    const row: Record<string, string> = {};
    headers.forEach((h, i) => {
      row[h] = cols[i] ?? "";
    });
    return row as CsvRow;
  });
}

export async function getStaticPaths() {
  try {
    const a = readCsv("data/profiles.csv");
    const b = readCsv("data/popular.csv");
    const byId = new Map<string, CsvRow>();
    for (const r of [...a, ...b]) {
      if (!r?.profile_id) continue;
      if (!byId.has(r.profile_id)) byId.set(r.profile_id, r);
    }
    if (byId.size === 0) return [];
    const paths = Array.from(byId.values()).map((r) => ({
      params: { slug: slugifyName(r.profile_name ?? r.profile_id) },
      props: {
        ssrProfile: {
          id: String(r.profile_id),
          name: r.profile_name ?? "",
          province: r.province ?? "",
          city: r.city ?? "",
          age: r.age ? Number.parseInt(r.age, 10) : undefined,
          height: r.length ?? "",
          description: r.aboutme ?? "",
          img: { src: r.profile_image ?? "/img/fallback.svg", alt: r.profile_name ?? "Profielafbeelding" },
        },
      },
    }));
    return paths;
  } catch {
    // Fail-safe: geen crash bij tijdelijk leesprobleem
    return [];
  }
}

const { ssrProfile } = Astro.props as {
  ssrProfile?: {
    id: string;
    name: string;
    province?: string;
    city?: string;
    age?: number;
    height?: string;
    description?: string;
    img?: { src: string; alt: string };
  };
};

// ID uit query; bij mismatch NIET meer 404’en — we tonen SSG en laten JS de deeplink bijwerken
const q = new URL(Astro.url).searchParams;
const idParam = q.get("id") ?? (ssrProfile?.id ?? "");

// SEO & canonical
const title = ssrProfile?.name ? `Date met ${ssrProfile.name}${ssrProfile.province ? ` in ${ssrProfile.province}` : ""}` : "Profiel";
const description = ssrProfile?.description ?? `Leer dit profiel kennen en stuur gratis een bericht.`;
const canonicalPath = `${Astro.url.pathname}${idParam ? `?id=${encodeURIComponent(String(idParam))}` : ""}`;

// Afbeelding + fallback
const imgSrc = ssrProfile?.img?.src ?? "/img/fallback.svg";
const imgAlt = ssrProfile?.img?.alt ?? ssrProfile?.name ?? "Profielafbeelding";

const hasSSG = Boolean(ssrProfile);

// JSON-LD minimaal
const personLd = ssrProfile?.name ? { "@type": "Person", name: ssrProfile.name, description: ssrProfile.description ?? undefined } : undefined;
---
<Base title={title} description={description} path={canonicalPath} staging={import.meta.env.STAGING} jsonLd={personLd ? [personLd] : []}>
  {hasSSG ? (
    <article class="mx-auto grid max-w-5xl grid-cols-1 gap-8 md:grid-cols-[360px,1fr]">
      <div class="overflow-hidden rounded-2xl border border-neutral-200 bg-white">
        <img
          id="profile-img"
          src={imgSrc}
          alt={imgAlt}
          loading="eager"
          decoding="async"
          class="block h-auto w-full object-cover"
        />
      </div>

      <div class="space-y-4">
        <header>
          <h1 class="text-3xl font-bold text-neutral-900">{ssrProfile!.name}</h1>
          <p class="text-neutral-700">
            {(ssrProfile!.age ? `${ssrProfile!.age} jaar · ` : "")}{ssrProfile!.city || ssrProfile!.province}
          </p>
        </header>

        {ssrProfile!.description && (
          <p class="text-neutral-800 leading-relaxed">{ssrProfile!.description}</p>
        )}

        <section class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Provincie</p>
            <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.province}</p>
          </div>

          {ssrProfile!.city && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Stad</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.city}</p>
            </div>
          )}

          {ssrProfile!.age && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Leeftijd</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.age}</p>
            </div>
          )}

          {ssrProfile!.height && (
            <div class="rounded-xl border border-neutral-200 bg-white p-4">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Lengte</p>
              <p class="mt-1 font-medium text-neutral-900">{ssrProfile!.height}</p>
            </div>
          )}
        </section>

        <div class="pt-2">
          <a
            id="profile-cta"
            href="#"
            rel="nofollow sponsored noopener"
            target="_blank"
            class="inline-flex items-center justify-center rounded-full bg-sky-600 px-6 py-3 text-base font-semibold text-white transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
            aria-label="Stuur gratis bericht"
          >
            Stuur gratis bericht
          </a>
        </div>
      </div>
    </article>
  ) : (
    // Geen SSG-match → render container; client-fallback bouwt volledige view
    <>
      <div id="profile-view"></div>
    </>
  )}
  <script type="module" src="/js/profile-fallback.js"></script>
</Base>
