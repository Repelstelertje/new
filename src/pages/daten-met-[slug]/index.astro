---
import Base from "../../layouts/Base.astro";
import { config } from "../../lib/config";
import { getProvince, getPopular } from "../../lib/api";
import { PROVINCES } from "../../lib/provinces";
import { slugifyName } from "../../lib/slug";

type CardProfile = Awaited<ReturnType<typeof getProvince>>["profiles"][number];

export async function getStaticPaths() {
  const pageSize = config.api.limits?.pageSize ?? 60;

  // Gebruik bracket-arraytype ipv Array<...> om parser-issues te voorkomen
  const paths: { params: { slug: string }; props: { profile: CardProfile } }[] = [];
  const seen = new Set<string>();

  const pushProfile = (profile: CardProfile) => {
    const slug = slugifyName(profile.name);
    const key = `${slug}#${profile.id}`;
    if (seen.has(key)) return;
    seen.add(key);
    paths.push({ params: { slug }, props: { profile } });
  };

  // Neem ook populaire profielen mee zodat homepage-kaarten altijd een detailpagina hebben
  try {
    const popular = await getPopular(240);
    for (const profile of popular) {
      pushProfile(profile as CardProfile);
    }
  } catch {}

  // Verzamel ALLE profielen die we tijdens build kunnen ophalen
  for (const provinceName of PROVINCES) {
    const first = await getProvince(provinceName, pageSize, 1);
    const totalPages = first.totalPages ?? 1;

    const collect = async (page: number) => {
      const data = page === 1 ? first : await getProvince(provinceName, pageSize, page);
      for (const profile of data.profiles) {
        pushProfile(profile);
      }
    };

    for (let page = 1; page <= totalPages; page++) {
      await collect(page);
    }
  }

  return paths;
}

const { profile } = Astro.props as { profile: CardProfile };

// Geen harde redirect meer bij query-id mismatch; render altijd.
// We nemen id uit query op in canonical voor stabiliteit.
const q = new URL(Astro.url).searchParams;
const idParam = q.get("id") ?? String(profile.id);

// SEO & canonical
const title = `Date met ${profile.name} in ${profile.province}`;
const description = profile.description ?? `Leer ${profile.name} kennen en stuur gratis een bericht.`;
const canonicalPath = `${Astro.url.pathname}?id=${encodeURIComponent(String(idParam))}`;

// Afbeelding + fallback
const imgSrc = profile.img?.src ?? "/img/fallback.svg";
const imgAlt = profile.img?.alt ?? profile.name;

const analyticsProps = JSON.stringify({
  profile_id: String(profile.id),
  province: profile.province,
  chat_url: profile.deeplink,
});

// JSON-LD minimaal
const personLd = { "@type": "Person", name: profile.name, description: profile.description ?? undefined };
---
<Base title={title} description={description} path={canonicalPath} staging={import.meta.env.STAGING} jsonLd={[personLd]}>
  <article class="mx-auto grid max-w-5xl grid-cols-1 gap-8 md:grid-cols-[360px,1fr]">
    <div class="overflow-hidden rounded-2xl border border-neutral-200 bg-white">
      <img
        src={imgSrc}
        alt={imgAlt}
        loading="eager"
        decoding="async"
        class="block w-full h-auto"
        data-fallback-src="/img/fallback.svg"
      />
    </div>

    <div class="space-y-4">
      <header>
        <h1 class="text-3xl font-bold text-neutral-900">{profile.name}</h1>
        <p class="text-neutral-700">{profile.age} jaar Â· {profile.province}</p>
      </header>

      {profile.description && (
        <p class="text-neutral-800 leading-relaxed">{profile.description}</p>
      )}

      <section class="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
        <div class="rounded-xl border border-neutral-200 bg-white p-4">
          <p class="text-xs uppercase tracking-wide text-neutral-500">Provincie</p>
          <p class="mt-1 font-medium text-neutral-900">{profile.province}</p>
        </div>

        {profile.city && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Stad</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.city}</p>
          </div>
        )}

        <div class="rounded-xl border border-neutral-200 bg-white p-4">
          <p class="text-xs uppercase tracking-wide text-neutral-500">Leeftijd</p>
          <p class="mt-1 font-medium text-neutral-900">{profile.age}</p>
        </div>

        {profile.relationship && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Relatiestatus</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.relationship}</p>
          </div>
        )}

        {profile.height && (
          <div class="rounded-xl border border-neutral-200 bg-white p-4">
            <p class="text-xs uppercase tracking-wide text-neutral-500">Lengte</p>
            <p class="mt-1 font-medium text-neutral-900">{profile.height}</p>
          </div>
        )}
      </section>

      <div class="pt-2">
        <a
          href={profile.deeplink}
          rel="nofollow sponsored noopener"
          target="_blank"
        class="inline-flex items-center justify-center rounded-full bg-sky-600 px-6 py-3 text-base font-semibold text-white transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
        aria-label="Stuur gratis bericht"
        data-analytics="outbound_click"
        data-props={analyticsProps}
      >
          Stuur gratis bericht
        </a>
      </div>
    </div>
  </article>
</Base>
