---
interface ProfileCardImage {
  src: string;
  alt: string;
  srcset?: string;
  sizes?: string;
}

const FALLBACK_WIDTHS = [320, 480, 960];

const ensureResponsiveSrcset = (src: string, provided?: string) => {
  const entries: string[] = [];
  const seen = new Set<number>();

  if (provided) {
    for (const candidate of provided.split(",")) {
      const value = candidate.trim();
      if (!value) continue;
      entries.push(value);
      const match = value.match(/(\d+)\s*w/i);
      if (match) {
        const width = Number.parseInt(match[1] ?? "", 10);
        if (Number.isFinite(width)) seen.add(width);
      }
    }
  }

  for (const width of FALLBACK_WIDTHS) {
    if (!seen.has(width)) {
      entries.push(`${src} ${width}w`);
    }
  }

  return entries.join(", ");
};

const placeholderSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 24'>` +
  `<defs>` +
  `<linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>` +
  `<stop offset='0%' stop-color='#e2e8f0'/>` +
  `<stop offset='100%' stop-color='#cbd5f5'/>` +
  `</linearGradient>` +
  `<filter id='b'><feGaussianBlur stdDeviation='6' /></filter>` +
  `</defs>` +
  `<rect width='32' height='24' fill='#e2e8f0'/>` +
  `<rect width='32' height='24' fill='url(#g)' filter='url(#b)'/>` +
  `</svg>`;

const blurDataUrl = `data:image/svg+xml,${encodeURIComponent(placeholderSvg)}`;

const {
  id,
  name,
  age,
  province,
  img,
  deeplink,
  description,
  rank,
} = Astro.props as {
  id: string | number;
  name: string;
  age: number;
  province: string;
  img: ProfileCardImage;
  deeplink: string;
  description?: string;
  rank?: number;
};

// helper: kort en netjes afbreken rond woordgrens
function trim(text: string, max = 140) {
  if (!text) return "";
  if (text.length <= max) return text;
  const sliced = text.slice(0, max);
  const cutAt = Math.max(sliced.lastIndexOf(" "), Math.floor(max * 0.9));
  return sliced.slice(0, cutAt).trimEnd() + "â€¦";
}

const preview = description ? trim(description, 140) : "";

const responsiveSrcset = ensureResponsiveSrcset(img.src, img.srcset);
const responsiveSizes =
  img.sizes ?? "(min-width: 1024px) 25vw, (min-width: 768px) 33vw, 100vw";
const analyticsProps = JSON.stringify({
  chat_url: deeplink,
  province,
  rank,
  profile_id: String(id),
});
---
<article
  class="flex h-full flex-col overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm transition hover:border-sky-500 hover:shadow-lg"
  data-profile-id={id}
>
  <a
    href={deeplink}
    aria-label={`Bekijk profiel van ${name}`}
    rel="nofollow sponsored noopener"
    class="group relative block focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-600"
    data-analytics="outbound_click"
    data-props={analyticsProps}
  >
    <picture
      class="block aspect-[4/3] overflow-hidden bg-slate-100"
      style={`background-image: url('${blurDataUrl}'); background-size: cover; background-position: center;`}
    >
      <img
        src={img.src}
        alt={img.alt}
        srcset={responsiveSrcset}
        sizes={responsiveSizes}
        loading="lazy"
        decoding="async"
        class="h-full w-full object-cover transition duration-500 group-hover:scale-105"
        onerror={`this.onerror=null; this.src='${"/img/fallback.svg"}'; this.srcset='';`}
      />
    </picture>
  </a>
  <div class="flex flex-1 flex-col gap-4 p-6 text-slate-900">
    <div>
      <h3 class="text-xl font-semibold text-slate-900">{name}</h3>
      <p class="text-sm text-slate-700">{age} jaar &middot; {province}</p>
    </div>
    {preview && (
      <p
        class="text-sm text-slate-700"
        title={description}
        style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;"
      >
        {preview}
      </p>
    )}
    <div class="mt-auto">
      <a
        href={deeplink}
        aria-label={`Start gesprek met ${name}`}
        rel="nofollow sponsored noopener"
        class="inline-flex items-center justify-center rounded-full bg-sky-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-400"
        data-analytics="outbound_click"
        data-props={analyticsProps}
      >
        Profiel bekijken
      </a>
    </div>
  </div>
</article>
